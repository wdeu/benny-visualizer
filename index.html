<!DOCTYPE html>

<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Castagnari Benny Visualizer</title>
<style>
/* ===================== RESET & VARIABLES ===================== */
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

:root {
â€“bg: #1c1c1e;
â€“bg-card: #2c2c2e;
â€“bg-inset: #3a3a3c;
â€“text-primary: #f2f2f7;
â€“text-secondary: #8e8e93;
â€“text-tertiary: #636366;
â€“separator: #38383a;
â€“accent: #0a84ff;
â€“accent-subtle: rgba(10,132,255,0.15);
â€“pearl-top: #e8e4df;
â€“pearl-mid: #d6d1cb;
â€“pearl-bot: #c4bfb8;
â€“pearl-shadow: rgba(0,0,0,0.35);
â€“pearl-text: #3a3a3c;
}

html, body {
height: 100%;
background: var(â€“bg);
color: var(â€“text-primary);
font-family: -apple-system, BlinkMacSystemFont, â€˜SF Pro Textâ€™, â€˜Helvetica Neueâ€™, sans-serif;
-webkit-font-smoothing: antialiased;
overflow-x: hidden;
}

/* ===================== LAYOUT CONTAINER ===================== */
.container {
max-width: 680px;
margin: 0 auto;
padding: 20px 16px 40px;
}

/* ===================== HEADER ===================== */
header {
text-align: center;
padding: 24px 0 20px;
}
header h1 {
font-size: 1.7em;
font-weight: 600;
color: var(â€“text-primary);
letter-spacing: -0.3px;
}
header .subtitle {
font-size: 0.78em;
color: var(â€“text-secondary);
letter-spacing: 1.2px;
margin-top: 4px;
text-transform: uppercase;
}

/* ===================== GROUPED SECTIONS (iOS style) ===================== */
.section {
background: var(â€“bg-card);
border-radius: 12px;
margin-bottom: 12px;
overflow: hidden;
}
.section-header {
padding: 10px 16px 4px;
font-size: 0.72em;
font-weight: 600;
color: var(â€“text-secondary);
text-transform: uppercase;
letter-spacing: 1px;
}

/* ===================== CONTROLS ===================== */
.control-row {
display: flex;
padding: 10px 12px;
gap: 8px;
}

/* Segmented control â€“ Balgrichtung */
.seg-control {
display: flex;
flex: 1;
background: var(â€“bg-inset);
border-radius: 8px;
overflow: hidden;
height: 36px;
}
.seg-btn {
flex: 1;
border: none;
background: transparent;
color: var(â€“text-secondary);
font-size: 0.88em;
font-weight: 500;
cursor: pointer;
transition: background 0.2s, color 0.2s;
font-family: inherit;
}
.seg-btn.active {
background: var(â€“bg-card);
color: var(â€“text-primary);
box-shadow: 0 1px 3px rgba(0,0,0,0.4);
border-radius: 6px;
margin: 2px;
height: calc(100% - 4px);
}

/* Modus-Umschaltung */
.mode-row {
display: flex;
gap: 8px;
padding: 10px 12px;
}
.mode-btn {
flex: 1;
height: 34px;
border: 1px solid var(â€“separator);
border-radius: 8px;
background: transparent;
color: var(â€“text-secondary);
font-size: 0.82em;
font-weight: 500;
cursor: pointer;
font-family: inherit;
transition: all 0.2s;
}
.mode-btn.active {
background: var(â€“accent-subtle);
border-color: var(â€“accent);
color: var(â€“accent);
}

/* StÃ¼ck-Select */
.piece-row {
padding: 8px 12px;
}
.piece-row select {
width: 100%;
height: 40px;
background: var(â€“bg-inset);
border: none;
border-radius: 8px;
color: var(â€“text-primary);
font-size: 0.9em;
font-family: inherit;
padding: 0 12px;
-webkit-appearance: none;
appearance: none;
background-image: url(â€œdata:image/svg+xml,%3Csvg xmlns=â€˜http://www.w3.org/2000/svgâ€™ width=â€˜12â€™ height=â€˜12â€™ viewBox=â€˜0 0 12 12â€™%3E%3Cpath fill=â€™%238e8e93â€™ d=â€˜M2 4l4 4 4-4zâ€™/%3E%3C/svg%3Eâ€);
background-repeat: no-repeat;
background-position: right 12px center;
}
.piece-row select option { background: var(â€“bg-card); }

/* Clear button */
.clear-btn {
display: block;
width: calc(100% - 24px);
margin: 8px 12px;
height: 36px;
background: transparent;
border: 1px solid var(â€“separator);
border-radius: 8px;
color: var(â€“text-secondary);
font-size: 0.85em;
font-family: inherit;
cursor: pointer;
transition: background 0.15s;
}
.clear-btn:active { background: var(â€“bg-inset); }

/* ===================== CHORD PANEL ===================== */
.chord-panel {
background: var(â€“bg-card);
border-radius: 12px;
margin-bottom: 12px;
padding: 12px;
display: none;
}
.chord-panel.visible { display: block; }

.chord-panel .panel-label {
font-size: 0.72em;
font-weight: 600;
color: var(â€“text-secondary);
text-transform: uppercase;
letter-spacing: 1px;
margin-bottom: 8px;
}
.chip-row {
display: flex;
gap: 6px;
flex-wrap: wrap;
margin-bottom: 12px;
}
.chip {
height: 30px;
padding: 0 14px;
border-radius: 15px;
border: 1px solid var(â€“separator);
background: var(â€“bg-inset);
color: var(â€“text-secondary);
font-size: 0.82em;
font-weight: 500;
font-family: inherit;
cursor: pointer;
transition: all 0.15s;
}
.chip:active { opacity: 0.7; }
.chip.active {
background: var(â€“accent-subtle);
border-color: var(â€“accent);
color: var(â€“accent);
}

.chord-hint {
font-size: 0.78em;
color: var(â€“text-tertiary);
line-height: 1.4;
margin-top: 4px;
}

/* ===================== ACCORDION LAYOUT ===================== */
.layout-section { display: none; }
.layout-section.visible { display: block; }

.layout-title {
font-size: 0.72em;
font-weight: 600;
color: var(â€“text-secondary);
text-transform: uppercase;
letter-spacing: 1px;
padding: 14px 4px 8px;
}

/* Diskant: 3 Reihen horizontal */
.treble-side {
display: flex;
gap: 10px;
justify-content: center;
align-items: flex-start;
}
.row {
display: flex;
flex-direction: column;
gap: 5px;
align-items: center;
}
.row-label {
font-size: 0.68em;
color: var(â€“text-tertiary);
font-weight: 600;
letter-spacing: 0.8px;
text-align: center;
margin-bottom: 3px;
}

/* ===================== PERLMUTT BUTTONS ===================== */
.note-button {
width: 68px;
height: 68px;
border-radius: 50%;
background: linear-gradient(160deg, var(â€“pearl-top) 0%, var(â€“pearl-mid) 45%, var(â€“pearl-bot) 100%);
border: 2px solid rgba(255,255,255,0.25);
box-shadow:
inset 0 2px 3px rgba(255,255,255,0.55),
inset 0 -1px 2px rgba(0,0,0,0.12),
0 3px 6px var(â€“pearl-shadow);
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
position: relative;
transition: transform 0.15s, box-shadow 0.15s;
-webkit-tap-highlight-color: transparent;
}
/* Pearl gloss highlight */
.note-button::before {
content: â€˜â€™;
position: absolute;
top: 8%; left: 18%;
width: 38%; height: 35%;
background: radial-gradient(ellipse, rgba(255,255,255,0.55) 0%, transparent 70%);
border-radius: 50%;
pointer-events: none;
}
.note-button .note-name {
font-size: 0.88em;
font-weight: 600;
color: var(â€“pearl-text);
position: relative;
z-index: 1;
text-align: center;
line-height: 1.1;
}

/* Pressed state */
.note-button:active { transform: scale(0.92); }

/* Active (toggled on) â€“ neutral dark */
.note-button.active {
background: linear-gradient(160deg, #555 0%, #444 45%, #3a3a3a 100%);
border-color: rgba(255,255,255,0.15);
box-shadow:
inset 0 2px 3px rgba(255,255,255,0.1),
inset 0 -1px 2px rgba(0,0,0,0.3),
0 2px 4px rgba(0,0,0,0.4);
}
.note-button.active .note-name { color: #f2f2f7; }

/* ROOT TONE â€“ the only colour accent in the whole app */
.note-button.root {
border: 3px solid var(â€“accent);
box-shadow:
inset 0 2px 3px rgba(255,255,255,0.55),
inset 0 -1px 2px rgba(0,0,0,0.12),
0 3px 6px var(â€“pearl-shadow),
0 0 0 2px var(â€“accent-subtle);
}
.note-button.root.active {
background: linear-gradient(160deg, #1a5fa8 0%, #0a84ff 50%, #0066cc 100%);
border-color: var(â€“accent);
box-shadow:
inset 0 2px 3px rgba(255,255,255,0.15),
0 0 12px rgba(10,132,255,0.45);
}
.note-button.root.active .note-name { color: #fff; }

/* Scale-tone hint â€“ very subtle ring */
.note-button.scale-tone {
border-color: rgba(255,255,255,0.45);
box-shadow:
inset 0 2px 3px rgba(255,255,255,0.55),
inset 0 -1px 2px rgba(0,0,0,0.12),
0 3px 6px var(â€“pearl-shadow),
0 0 0 2px rgba(142,142,147,0.25);
}

/* ===================== BASS BUTTONS ===================== */
.bass-container {
display: flex;
gap: 24px;
justify-content: center;
margin-top: 6px;
}
.bass-column {
display: flex;
flex-direction: column;
gap: 5px;
align-items: center;
}
.bass-column-label {
font-size: 0.68em;
color: var(â€“text-tertiary);
font-weight: 600;
letter-spacing: 0.8px;
margin-bottom: 3px;
}

.bass-button {
width: 58px;
height: 58px;
border-radius: 50%;
background: linear-gradient(160deg, var(â€“pearl-top) 0%, var(â€“pearl-mid) 45%, var(â€“pearl-bot) 100%);
border: 2px solid rgba(255,255,255,0.25);
box-shadow:
inset 0 2px 3px rgba(255,255,255,0.55),
inset 0 -1px 2px rgba(0,0,0,0.12),
0 3px 6px var(â€“pearl-shadow);
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
position: relative;
transition: transform 0.15s, box-shadow 0.15s;
font-size: 0.9em;
font-weight: 700;
color: var(â€“pearl-text);
-webkit-tap-highlight-color: transparent;
}
.bass-button::before {
content: â€˜â€™;
position: absolute;
top: 8%; left: 18%;
width: 38%; height: 35%;
background: radial-gradient(ellipse, rgba(255,255,255,0.55) 0%, transparent 70%);
border-radius: 50%;
pointer-events: none;
}
.bass-button:active { transform: scale(0.9); }

.bass-button.active {
background: linear-gradient(160deg, #555 0%, #444 45%, #3a3a3a 100%);
border-color: rgba(255,255,255,0.15);
box-shadow:
inset 0 2px 3px rgba(255,255,255,0.1),
inset 0 -1px 2px rgba(0,0,0,0.3),
0 2px 4px rgba(0,0,0,0.4);
color: #f2f2f7;
}

/* Bass-Kleinbuchstabe = Dreiklang, optisch etwas kleiner */
.bass-button.is-chord { font-size: 0.82em; }

/* ===================== INFO PANEL ===================== */
.info-panel {
background: var(â€“bg-card);
border-radius: 12px;
margin-top: 12px;
padding: 12px 16px;
display: none;
}
.info-panel.visible { display: block; }
.info-panel .info-title {
font-size: 0.72em;
font-weight: 600;
color: var(â€“text-secondary);
text-transform: uppercase;
letter-spacing: 1px;
margin-bottom: 8px;
}
.info-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 8px;
}
.info-item .info-label {
font-size: 0.72em;
color: var(â€“text-tertiary);
margin-bottom: 2px;
}
.info-item .info-value {
font-size: 0.9em;
color: var(â€“text-primary);
font-weight: 500;
}

/* ===================== LEGEND ===================== */
.legend {
background: var(â€“bg-card);
border-radius: 12px;
margin-top: 12px;
padding: 12px 16px;
display: none;
}
.legend.visible { display: block; }
.legend .legend-title {
font-size: 0.72em;
font-weight: 600;
color: var(â€“text-secondary);
text-transform: uppercase;
letter-spacing: 1px;
margin-bottom: 8px;
}
.legend-row {
display: flex;
align-items: center;
gap: 10px;
margin-bottom: 5px;
font-size: 0.82em;
color: var(â€“text-secondary);
}
.legend-swatch {
width: 22px;
height: 22px;
border-radius: 50%;
flex-shrink: 0;
}
.legend-swatch.pearl {
background: linear-gradient(160deg, var(â€“pearl-top), var(â€“pearl-bot));
border: 2px solid rgba(255,255,255,0.25);
}
.legend-swatch.active-swatch {
background: #444;
border: 2px solid rgba(255,255,255,0.15);
}
.legend-swatch.root-swatch {
background: linear-gradient(160deg, var(â€“pearl-top), var(â€“pearl-bot));
border: 3px solid var(â€“accent);
box-shadow: 0 0 0 2px var(â€“accent-subtle);
}
.legend-swatch.scale-swatch {
background: linear-gradient(160deg, var(â€“pearl-top), var(â€“pearl-bot));
border: 2px solid rgba(142,142,147,0.5);
box-shadow: 0 0 0 2px rgba(142,142,147,0.25);
}

/* ===================== RESPONSIVE ===================== */
@media (max-width: 400px) {
.note-button { width: 58px; height: 58px; }
.note-button .note-name { font-size: 0.8em; }
.bass-button { width: 50px; height: 50px; font-size: 0.82em; }
.treble-side { gap: 6px; }
.bass-container { gap: 16px; }
}
</style>

</head>
<body>
<div class="container">

<!-- HEADER -->

<header>
    <h1>ğŸª— Castagnari Benny Visualizer</h1>
    <p class="subtitle">C/G Â· 3-reihig Â· Heim Â· Spieler-Perspektive</p>
</header>

<!-- BALGRICHTUNG + MODUS -->

<div class="section">
    <div class="section-header">Balgrichtung</div>
    <div class="control-row">
        <div class="seg-control">
            <button class="seg-btn active" data-dir="pull">â† Pull (Ziehen)</button>
            <button class="seg-btn" data-dir="push">Push (DrÃ¼cken) â†’</button>
        </div>
    </div>
    <div class="section-header" style="margin-top:4px;">Modus</div>
    <div class="mode-row">
        <button class="mode-btn active" data-mode="normal">Normal</button>
        <button class="mode-btn" data-mode="chord">ğŸ¼ Akkorde</button>
    </div>
</div>

<!-- AKKORD-PANEL -->

<div class="chord-panel" id="chordPanel">
    <div class="panel-label">Akkordtyp</div>
    <div class="chip-row" id="chordTypeRow">
        <button class="chip active" data-ctype="maj">Dur</button>
        <button class="chip" data-ctype="min">Moll</button>
        <button class="chip" data-ctype="7">Dom 7</button>
        <button class="chip" data-ctype="maj7">Maj 7</button>
        <button class="chip" data-ctype="dim">dim</button>
        <button class="chip" data-ctype="aug">aug</button>
    </div>
    <div class="panel-label">Modale Skalen</div>
    <div class="chip-row" id="scaleRow">
        <button class="chip" data-scale="dorian">Dorisch</button>
        <button class="chip" data-scale="mixolydian">Mixolydisch</button>
        <button class="chip" data-scale="phrygian">Phrygisch</button>
        <button class="chip" data-scale="lydian">Lydisch</button>
    </div>
    <div class="chord-hint">Klicke auf einen Bass-Knopf â†’ Diskant zeigt den Akkord.<br>
    <strong style="color:var(--text-secondary);">GroÃŸbuchstabe</strong> = Grundton Â· <strong style="color:var(--text-secondary);">Kleinbuchstabe</strong> = Dreiklang</div>
</div>

<!-- STÃœCK AUSWÃ„HLEN -->

<div class="section">
    <div class="section-header">StÃ¼ck</div>
    <div class="piece-row">
        <select id="pieceSelect">
            <option value="">â€” StÃ¼ck wÃ¤hlen â€”</option>
            <option value="bourree-avignon">BourrÃ©e d'Avignon (D-moll)</option>
            <option value="bourree-malochet">BourrÃ©e Ã  Malochet (G-Dur)</option>
            <option value="chapelloise">Chapelloise (G-Dur)</option>
            <option value="scottish-berry">Scottish du Berry (G-Dur)</option>
            <option value="polka-tailleurs">Polka des Tailleurs (C-Dur)</option>
        </select>
    </div>
    <button class="clear-btn" id="clearBtn">Alle lÃ¶schen</button>
</div>

<!-- ACCORDION LAYOUT â€“ PULL -->

<div class="layout-section visible" id="pull-layout">
    <div class="layout-title">Diskant â€“ Pull (Ziehen) â€“ Sicht von oben</div>
    <div class="treble-side" id="treble-pull"></div>
    <div class="layout-title" style="margin-top:18px;">Bass â€“ Pull</div>
    <div class="bass-container" id="bass-pull"></div>
</div>

<!-- ACCORDION LAYOUT â€“ PUSH -->

<div class="layout-section" id="push-layout">
    <div class="layout-title">Diskant â€“ Push (DrÃ¼cken) â€“ Sicht von oben</div>
    <div class="treble-side" id="treble-push"></div>
    <div class="layout-title" style="margin-top:18px;">Bass â€“ Push</div>
    <div class="bass-container" id="bass-push"></div>
</div>

<!-- INFO PANEL -->

<div class="info-panel" id="infoPanel">
    <div class="info-title">StÃ¼ck-Info</div>
    <div class="info-grid">
        <div class="info-item"><div class="info-label">Tonart</div><div class="info-value" id="infoKey">â€”</div></div>
        <div class="info-item"><div class="info-label">Hauptreihe</div><div class="info-value" id="infoRow">â€”</div></div>
        <div class="info-item"><div class="info-label">Helferreihe</div><div class="info-value" id="infoHelper">â€”</div></div>
        <div class="info-item"><div class="info-label">Balg</div><div class="info-value" id="infoBellows">â€”</div></div>
    </div>
</div>

<!-- LEGEND -->

<div class="legend" id="legend">
    <div class="legend-title">Legende</div>
    <div class="legend-row"><div class="legend-swatch pearl"></div>Taste â€“ nicht aktiv</div>
    <div class="legend-row"><div class="legend-swatch active-swatch"></div>Taste â€“ aktiv (angetippt / StÃ¼ck)</div>
    <div class="legend-row"><div class="legend-swatch root-swatch"></div>Grundton des Akkords</div>
    <div class="legend-row"><div class="legend-swatch scale-swatch"></div>Skalenton (bei modalen Skalen)</div>
</div>

</div><!-- /container -->

<script>
// â”€â”€â”€ LAYOUT DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const layout = {
    pull: {
        treble: {
            Heim: ['C# 10','Bb 9','G# 8','G 7','C# 6','Bb 5','G# 4','G 3','C# 2','Bb 1'],
            C:    ['D 11','B 10','A 9','F 8','D 7','B 6','A 5','F 4','D 3','B 2','G 1'],
            G:    ['C 12','A 11','F# 10','E 9','C 8','A 7','F# 6','E 5','C 4','A 3','F# 2','E 1']
        },
        bass: {
            col1: ['G','g','D','d','B','b'],
            col2: ['F','f','A','a','Bb','bb']
        }
    },
    push: {
        treble: {
            Heim: ['G# 10','Eb 9','A 8','G# 7','Eb 6','A 5','G# 4','Eb 3','A 2','G# 1'],
            C:    ['G 11','E 10','C 9','G 8','E 7','C 6','G 5','E 4','C 3','G 2','E 1'],
            G:    ['G 12','D 11','B 10','G 9','D 8','B 7','G 6','D 5','B 4','G 3','D 2','B 1']
        },
        bass: {
            col1: ['C','c','G','g','Ab','ab'],
            col2: ['F','f','E','e','Eb','eb']
        }
    }
};

// â”€â”€â”€ PIECES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const pieces = {
    'bourree-avignon': {
        name: "BourrÃ©e d'Avignon", key: "D-moll",
        row: "G + Helferreihe", helper: "E, F (zwingend)", bellows: "â‰ˆ 90 % Pull",
        notes: {
            pull:  { treble: ['E 9','D 7','A 7','F# 10','C 8'], bass: ['D','d','A','a'] },
            push: { treble: ['D 11','G 9'],                      bass: [] }
        }
    },
    'bourree-malochet': {
        name: "BourrÃ©e Ã  Malochet", key: "G-Dur (dorisch)",
        row: "G-Reihe + Helfer", helper: "F fÃ¼r dorischen Charakter", bellows: "kurze Akzente",
        notes: {
            pull:  { treble: ['A 7','F# 10','E 9','C 8','A 3'], bass: ['G','g','D','d'] },
            push: { treble: ['G 9','D 8','B 10'],               bass: ['G','g'] }
        }
    },
    'chapelloise': {
        name: "Chapelloise", key: "G-Dur",
        row: "G-Reihe", helper: "nicht nÃ¶tig", bellows: "extrem stabil, lange Push-Phasen",
        notes: {
            pull:  { treble: ['A 7','F# 6','E 5','C 4','A 3'],  bass: ['G','g'] },
            push: { treble: ['G 12','G 9','D 11','B 10','G 6'], bass: ['G','g','C','c'] }
        }
    },
    'scottish-berry': {
        name: "Scottish du Berry", key: "G-Dur",
        row: "G + C", helper: "c / d zum GlÃ¤tten", bellows: "bewusst rhythmisch",
        notes: {
            pull:  { treble: ['A 7','F# 10','E 9','C 8','B 10'], bass: ['G','g','D','d'] },
            push: { treble: ['G 9','D 8','B 10','E 10'],         bass: ['G','g','C','c'] }
        }
    },
    'polka-tailleurs': {
        name: "Polka des Tailleurs", key: "C-Dur",
        row: "C-Reihe", helper: "optional f", bellows: "regelmÃ¤ÃŸig, vorhersehbar",
        notes: {
            pull:  { treble: ['B 6','A 5','F 4','D 3','B 2'], bass: ['G','g'] },
            push: { treble: ['C 9','E 10','G 8','C 6'],       bass: ['G','g','C','c'] }
        }
    }
};

// â”€â”€â”€ MUSIC THEORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const chordFormulas = { maj:[0,4,7], min:[0,3,7], '7':[0,4,7,10], maj7:[0,4,7,11], dim:[0,3,6], aug:[0,4,8] };
const scaleFormulas = { dorian:[0,2,3,5,7,9,10], mixolydian:[0,2,4,5,7,9,10], phrygian:[0,1,3,5,7,8,10], lydian:[0,2,4,6,7,9,11] };
const noteToSemitone = { 'C':0,'C#':1,'Db':1,'D':2,'D#':3,'Eb':3,'E':4,'F':5,'F#':6,'Gb':6,'G':7,'G#':8,'Ab':8,'A':9,'A#':10,'Bb':10,'B':11 };
const semitoneToNote = ['C','C#','D','Eb','E','F','F#','G','G#','A','Bb','B'];

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentDir       = 'pull';
let currentMode      = 'normal';
let activeNotes      = new Set();
let highlightRoot    = null;
let highlightScale   = new Set();
let selectedChordType= 'maj';
let selectedScale    = null;

// â”€â”€â”€ HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pureName(label) { return label.replace(/\s*\d+$/, '').trim(); }

// â”€â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll() { ['pull','push'].forEach(d => { renderTreble(d); renderBass(d); }); }

function renderTreble(dir) {
    const cont = document.getElementById('treble-' + dir);
    cont.innerHTML = '';
    ['Heim','C','G'].forEach(rowName => {
        const row = document.createElement('div');
        row.className = 'row';
        const lbl = document.createElement('div');
        lbl.className = 'row-label';
        lbl.textContent = rowName === 'Heim' ? 'HELFER (10)' : rowName === 'C' ? 'C-REIHE (11)' : 'G-REIHE (12)';
        row.appendChild(lbl);
        layout[dir].treble[rowName].forEach(note => {
            const btn = document.createElement('div');
            btn.className = 'note-button';
            btn.dataset.note = note;
            const span = document.createElement('div');
            span.className = 'note-name';
            span.textContent = note;
            btn.appendChild(span);
            btn.addEventListener('click', () => onTrebleClick(note, dir));
            row.appendChild(btn);
        });
        cont.appendChild(row);
    });
    refreshStyles(dir);
}

function renderBass(dir) {
    const cont = document.getElementById('bass-' + dir);
    cont.innerHTML = '';
    ['col1','col2'].forEach(col => {
        const column = document.createElement('div');
        column.className = 'bass-column';
        const lbl = document.createElement('div');
        lbl.className = 'bass-column-label';
        lbl.textContent = 'Spalte ' + (col === 'col1' ? '1' : '2');
        column.appendChild(lbl);
        layout[dir].bass[col].forEach(note => {
            const btn = document.createElement('div');
            btn.className = 'bass-button';
            if (note !== note.toUpperCase()) btn.classList.add('is-chord');
            btn.dataset.note = note;
            btn.textContent  = note;
            btn.addEventListener('click', () => onBassClick(note, dir));
            column.appendChild(btn);
        });
        cont.appendChild(column);
    });
    refreshStyles(dir);
}

// â”€â”€â”€ STYLE REFRESH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshStyles(dir) {
    document.querySelectorAll('#treble-' + dir + ' .note-button').forEach(btn => {
        const note = btn.dataset.note;
        const key  = dir + '-treble-' + note;
        const name = pureName(note);
        btn.classList.toggle('active',     activeNotes.has(key));
        btn.classList.toggle('root',       highlightRoot === name);
        btn.classList.toggle('scale-tone', highlightScale.has(name) && highlightRoot !== name);
    });
    document.querySelectorAll('#bass-' + dir + ' .bass-button').forEach(btn => {
        btn.classList.toggle('active', activeNotes.has(dir + '-bass-' + btn.dataset.note));
    });
}

// â”€â”€â”€ CLICK HANDLERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onTrebleClick(note, dir) {
    if (currentMode === 'chord') return;
    const key = dir + '-treble-' + note;
    activeNotes.has(key) ? activeNotes.delete(key) : activeNotes.add(key);
    refreshStyles(dir);
}

function onBassClick(note, dir) {
    if (currentMode === 'normal') {
        const key = dir + '-bass-' + note;
        activeNotes.has(key) ? activeNotes.delete(key) : activeNotes.add(key);
        refreshStyles(dir);
        return;
    }
    // Chord mode: derive root
    const root = note.charAt(0).toUpperCase() +
                 (note.length > 1 && (note[1] === 'b' || note[1] === '#') ? note[1] : '');
    clearHighlights();
    const rootSemi = noteToSemitone[root];
    highlightRoot  = root;
    const formula  = selectedScale ? scaleFormulas[selectedScale] : chordFormulas[selectedChordType];
    formula.forEach(interval => highlightScale.add(semitoneToNote[(rootSemi + interval) % 12]));
    refreshStyles(currentDir);
}

// â”€â”€â”€ PIECE LOADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadPiece(id) {
    clearAll();
    if (!id || !pieces[id]) { document.getElementById('infoPanel').classList.remove('visible'); return; }
    const p  = pieces[id];
    const pn = p.notes[currentDir];
    if (pn) {
        pn.treble.forEach(n => activeNotes.add(currentDir + '-treble-' + n));
        pn.bass.forEach(n  => activeNotes.add(currentDir + '-bass-'   + n));
    }
    document.getElementById('infoKey').textContent     = p.key;
    document.getElementById('infoRow').textContent     = p.row;
    document.getElementById('infoHelper').textContent  = p.helper;
    document.getElementById('infoBellows').textContent = p.bellows;
    document.getElementById('infoPanel').classList.add('visible');
    refreshStyles(currentDir);
}

// â”€â”€â”€ CLEAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clearAll()        { activeNotes.clear(); clearHighlights(); }
function clearHighlights() { highlightRoot = null; highlightScale = new Set(); refreshStyles('pull'); refreshStyles('push'); }

// â”€â”€â”€ DIRECTION SWITCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchDir(dir) {
    currentDir = dir;
    document.getElementById('pull-layout').classList.toggle('visible', dir === 'pull');
    document.getElementById('push-layout').classList.toggle('visible', dir === 'push');
    const sel = document.getElementById('pieceSelect').value;
    if (sel) loadPiece(sel); else { refreshStyles(dir); }
}

// â”€â”€â”€ MODE SWITCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchMode(mode) {
    currentMode = mode;
    document.getElementById('chordPanel').classList.toggle('visible', mode === 'chord');
    document.getElementById('legend').classList.toggle('visible',    mode === 'chord');
    clearHighlights();
    if (mode === 'normal') { const sel = document.getElementById('pieceSelect').value; if (sel) loadPiece(sel); }
}

// â”€â”€â”€ LISTENERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.seg-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        switchDir(btn.dataset.dir);
    });
});

document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        switchMode(btn.dataset.mode);
    });
});

document.querySelectorAll('.chip[data-ctype]').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.chip[data-ctype]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedChordType = btn.dataset.ctype;
        selectedScale = null;
        document.querySelectorAll('.chip[data-scale]').forEach(b => b.classList.remove('active'));
        clearHighlights();
    });
});

document.querySelectorAll('.chip[data-scale]').forEach(btn => {
    btn.addEventListener('click', () => {
        const was = btn.classList.contains('active');
        document.querySelectorAll('.chip[data-scale]').forEach(b => b.classList.remove('active'));
        if (!was) { btn.classList.add('active'); selectedScale = btn.dataset.scale; }
        else      { selectedScale = null; }
        if (selectedScale) document.querySelectorAll('.chip[data-ctype]').forEach(b => b.classList.remove('active'));
        clearHighlights();
    });
});

document.getElementById('pieceSelect').addEventListener('change', e => loadPiece(e.target.value));
document.getElementById('clearBtn').addEventListener('click', () => {
    clearAll(); document.getElementById('pieceSelect').value = '';
    document.getElementById('infoPanel').classList.remove('visible');
    refreshStyles('pull'); refreshStyles('push');
});

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
renderAll();
</script>

</body>
</html>
