<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Castagnari Benny Visualizer</title>
<style>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ RESET & VARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

:root {
    --bg:#1c1c1e; --bg-card:#2c2c2e; --bg-inset:#3a3a3c;
    --txt:#f2f2f7; --txt2:#8e8e93; --txt3:#636366;
    --sep:#38383a;
    --accent:#0a84ff; --accent-sub:rgba(10,132,255,0.18);
    --p0:#f0ece7; --p1:#ddd8d1; --p2:#ccc7bf;
    --p-shadow:rgba(0,0,0,0.30);
    --p-text:#3a3a3c;
    --act-bg:#4a4a4c;
    --act-txt:#f2f2f7;
    --root-bg:#3a3a3c;
    --root-txt:#f2f2f7;
}

html,body { height:100%; background:var(--bg); color:var(--txt);
    font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text','Helvetica Neue',sans-serif;
    -webkit-font-smoothing:antialiased; overflow-x:hidden; }

.container { max-width:1200px; margin:0 auto; padding:16px 16px 40px; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header { text-align:center; padding:20px 0 14px; }
header h1 { font-size:1.6em; font-weight:600; letter-spacing:-0.3px; }
header .sub { font-size:0.74em; color:var(--txt2); letter-spacing:1.2px; margin-top:3px; text-transform:uppercase; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SECTION CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section { background:var(--bg-card); border-radius:12px; margin-bottom:10px; overflow:hidden; }
.sec-hdr { padding:9px 16px 3px; font-size:0.7em; font-weight:600; color:var(--txt2);
    text-transform:uppercase; letter-spacing:1px; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SEGMENTED CONTROL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.seg { display:flex; background:var(--bg-inset); border-radius:8px; overflow:hidden; height:34px; margin:8px 12px; }
.seg button { flex:1; border:none; background:transparent; color:var(--txt2);
    font-size:0.86em; font-weight:500; cursor:pointer; font-family:inherit; transition:.15s; }
.seg button.active { background:var(--bg-card); color:var(--txt); border-radius:6px;
    margin:2px; height:calc(100% - 4px); box-shadow:0 1px 3px rgba(0,0,0,.4); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MODE PILLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mode-row { display:flex; gap:8px; padding:8px 12px; }
.mode-pill { flex:1; height:34px; border:1px solid var(--sep); border-radius:8px;
    background:transparent; color:var(--txt2); font-size:0.84em; font-weight:500;
    cursor:pointer; font-family:inherit; transition:.15s; }
.mode-pill.active { background:var(--accent-sub); border-color:var(--accent); color:var(--accent); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CHORD PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chord-panel { display:none; padding:0 12px 12px; }
.chord-panel.visible { display:block; }
.chord-panel .cp-label { font-size:0.7em; font-weight:600; color:var(--txt2);
    text-transform:uppercase; letter-spacing:1px; margin:10px 0 6px; }

.chip-row { display:flex; gap:6px; flex-wrap:wrap; }
.chip { height:28px; padding:0 13px; border-radius:14px; border:1px solid var(--sep);
    background:var(--bg-inset); color:var(--txt2); font-size:0.8em; font-weight:500;
    font-family:inherit; cursor:pointer; transition:.12s; }
.chip:active { opacity:.7; }
.chip.active { background:var(--accent-sub); border-color:var(--accent); color:var(--accent); }

.root-grid { display:flex; gap:5px; flex-wrap:wrap; margin-top:2px; }
.root-btn { min-width:38px; height:34px; padding:0 10px; border-radius:6px;
    border:1px solid var(--sep); background:var(--bg-inset); color:var(--txt2);
    font-size:0.82em; font-weight:600; font-family:inherit; cursor:pointer; transition:.12s; }
.root-btn:active { opacity:.7; }
.root-btn.active { background:var(--accent-sub); border-color:var(--accent); color:var(--accent); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ STÃœCK SELECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.piece-row { padding:8px 12px; }
.piece-row select { width:100%; height:38px; background:var(--bg-inset); border:none;
    border-radius:8px; color:var(--txt); font-size:0.88em; font-family:inherit; padding:0 12px;
    -webkit-appearance:none; appearance:none;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238e8e93' d='M2 4l4 4 4-4z'/%3E%3C/svg%3E");
    background-repeat:no-repeat; background-position:right 12px center; }
.piece-row select option { background:var(--bg-card); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ACCORDION LAYOUT â€“ SIDE BY SIDE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.layout-section { display:none; }
.layout-section.visible { display:block; }

/* FLEX container fÃ¼r Bass (links) + Diskant (rechts) bei genug Platz */
.accordion-flex {
    display:flex;
    gap:20px;
    justify-content:center;
    align-items:flex-start;
}

.bass-side, .treble-wrapper {
    flex-shrink:0;
}

.lay-title { font-size:0.7em; font-weight:600; color:var(--txt2); text-transform:uppercase;
    letter-spacing:1px; padding:10px 2px 6px; text-align:center; }

/* Diskant â€“ 3 Reihen nebeneinander */
.treble-side { display:flex; gap:8px; justify-content:center; align-items:flex-start; }
.row { display:flex; flex-direction:column; gap:4px; align-items:center; }
.row-label { font-size:0.66em; color:var(--txt3); font-weight:600; letter-spacing:0.7px;
    text-align:center; margin-bottom:2px; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PERLMUTT-TASTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.note-button {
    width:66px; height:66px; border-radius:50%;
    background:linear-gradient(160deg, var(--p0) 0%, var(--p1) 42%, var(--p2) 100%);
    border:1.5px solid rgba(255,255,255,.30);
    box-shadow: inset 0 2px 3px rgba(255,255,255,.50),
                inset 0 -1px 2px rgba(0,0,0,.10),
                0 2px 5px var(--p-shadow);
    display:flex; align-items:center; justify-content:center;
    cursor:pointer; position:relative;
    transition:transform .12s, box-shadow .12s, background .12s, border-color .12s;
}
.note-button::before { content:''; position:absolute; top:7%; left:17%;
    width:38%; height:34%; border-radius:50%; pointer-events:none;
    background:radial-gradient(ellipse, rgba(255,255,255,.52) 0%, transparent 70%); }

.note-button .note-name { font-size:0.85em; font-weight:600; color:var(--p-text);
    position:relative; z-index:1; text-align:center; line-height:1.1; }
.note-button:active { transform:scale(.93); }

.note-button.active {
    background:linear-gradient(160deg, #585858 0%, var(--act-bg) 50%, #404040 100%);
    border-color:rgba(255,255,255,.18);
    box-shadow: inset 0 1px 2px rgba(255,255,255,.12),
                inset 0 -1px 2px rgba(0,0,0,.25),
                0 2px 4px rgba(0,0,0,.35);
}
.note-button.active .note-name { color:var(--act-txt); }
.note-button.active::before { opacity:.15; }

.note-button.root {
    border:2.5px solid var(--accent);
    box-shadow: inset 0 2px 3px rgba(255,255,255,.50),
                inset 0 -1px 2px rgba(0,0,0,.10),
                0 2px 5px var(--p-shadow),
                0 0 0 2px var(--accent-sub);
}
.note-button.root.active {
    background:linear-gradient(160deg, #424242 0%, var(--root-bg) 50%, #2e2e2e 100%);
    border-color:var(--accent);
    box-shadow: inset 0 1px 2px rgba(255,255,255,.08),
                inset 0 -1px 2px rgba(0,0,0,.30),
                0 0 0 2px var(--accent-sub),
                0 0 8px rgba(10,132,255,.3);
}
.note-button.root.active .note-name { color:var(--root-txt); }

.note-button.scale-tone {
    box-shadow: inset 0 2px 3px rgba(255,255,255,.50),
                inset 0 -1px 2px rgba(0,0,0,.10),
                0 2px 5px var(--p-shadow),
                0 0 0 2px rgba(142,142,147,.22);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ BASS-TASTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bass-container { display:flex; gap:20px; justify-content:center; margin-top:4px; }
.bass-column { display:flex; flex-direction:column; gap:4px; align-items:center; }
.bass-col-label { font-size:0.66em; color:var(--txt3); font-weight:600;
    letter-spacing:0.7px; margin-bottom:2px; }

.bass-button {
    width:54px; height:54px; border-radius:50%;
    background:linear-gradient(160deg, var(--p0) 0%, var(--p1) 42%, var(--p2) 100%);
    border:1.5px solid rgba(255,255,255,.30);
    box-shadow: inset 0 2px 3px rgba(255,255,255,.50),
                inset 0 -1px 2px rgba(0,0,0,.10),
                0 2px 5px var(--p-shadow);
    display:flex; align-items:center; justify-content:center;
    cursor:pointer; position:relative;
    font-size:0.88em; font-weight:700; color:var(--p-text);
    transition:transform .12s, box-shadow .12s, background .12s;
}
.bass-button::before { content:''; position:absolute; top:7%; left:17%;
    width:38%; height:34%; border-radius:50%; pointer-events:none;
    background:radial-gradient(ellipse, rgba(255,255,255,.52) 0%, transparent 70%); }
.bass-button:active { transform:scale(.90); }
.bass-button.active {
    background:linear-gradient(160deg, #585858 0%, var(--act-bg) 50%, #404040 100%);
    border-color:rgba(255,255,255,.18);
    box-shadow: inset 0 1px 2px rgba(255,255,255,.12),
                inset 0 -1px 2px rgba(0,0,0,.25),
                0 2px 4px rgba(0,0,0,.35);
    color:var(--act-txt);
}
.bass-button.active::before { opacity:.15; }
.bass-button.is-chord { font-size:0.80em; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ INFO PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.info-panel { background:var(--bg-card); border-radius:12px; margin-top:10px; padding:12px 16px; display:none; }
.info-panel.visible { display:block; }
.info-panel .ip-title { font-size:0.7em; font-weight:600; color:var(--txt2);
    text-transform:uppercase; letter-spacing:1px; margin-bottom:6px; }
.info-grid { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
.info-item .il { font-size:0.7em; color:var(--txt3); margin-bottom:1px; }
.info-item .iv { font-size:0.88em; color:var(--txt); font-weight:500; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ LEGEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.legend { background:var(--bg-card); border-radius:12px; margin-top:10px; padding:10px 16px; display:none; }
.legend.visible { display:block; }
.legend .lg-title { font-size:0.7em; font-weight:600; color:var(--txt2);
    text-transform:uppercase; letter-spacing:1px; margin-bottom:6px; }
.lg-row { display:flex; align-items:center; gap:9px; margin-bottom:4px; font-size:0.8em; color:var(--txt2); }
.lg-sw { width:20px; height:20px; border-radius:50%; flex-shrink:0; }
.lg-sw.pearl  { background:linear-gradient(160deg,var(--p0),var(--p2)); border:1.5px solid rgba(255,255,255,.30); }
.lg-sw.act    { background:var(--act-bg); border:1.5px solid rgba(255,255,255,.18); }
.lg-sw.root   { background:var(--root-bg); border:2.5px solid var(--accent); box-shadow:0 0 0 2px var(--accent-sub); }
.lg-sw.scale  { background:linear-gradient(160deg,var(--p0),var(--p2)); border:1.5px solid rgba(255,255,255,.30);
    box-shadow:0 0 0 2px rgba(142,142,147,.22); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* Desktop & Landscape Tablets: Side-by-side */
@media (min-width:800px) {
    .accordion-flex {
        flex-direction:row;
    }
}

/* Portrait & Narrow: Stack vertically */
@media (max-width:799px) {
    .accordion-flex {
        flex-direction:column;
        align-items:center;
    }
    .bass-side {
        order:2; /* Bass nach unten */
    }
    .treble-wrapper {
        order:1; /* Diskant nach oben */
    }
}

/* Extra small screens */
@media (max-width:400px) {
    .note-button { width:56px; height:56px; }
    .note-button .note-name { font-size:0.78em; }
    .bass-button { width:46px; height:46px; font-size:0.80em; }
    .treble-side { gap:5px; }
    .bass-container { gap:14px; }
    .root-grid { gap:4px; }
    .root-btn { min-width:34px; height:30px; font-size:0.78em; }
}
</style>
</head>
<body>
<div class="container">

<header>
    <h1>ğŸª— Castagnari Benny Visualizer</h1>
    <p class="sub">C/G Â· 3-reihig Â· Heim Â· Spieler-Perspektive</p>
</header>

<!-- â”€â”€ STEUERUNG â”€â”€ -->
<div class="section">
    <div class="sec-hdr">Balgrichtung</div>
    <div class="seg">
        <button class="active" data-dir="pull">â† Pull (Ziehen)</button>
        <button data-dir="push">Push (DrÃ¼cken) â†’</button>
    </div>

    <div class="sec-hdr" style="margin-top:6px;">Modus</div>
    <div class="mode-row">
        <button class="mode-pill active" data-mode="normal">Normal</button>
        <button class="mode-pill" data-mode="chord">ğŸ¼ Akkorde</button>
    </div>

    <div class="chord-panel" id="chordPanel">
        <div class="cp-label">Akkordtyp</div>
        <div class="chip-row" id="chordTypeRow">
            <button class="chip active" data-ctype="maj">Dur</button>
            <button class="chip" data-ctype="min">Moll</button>
            <button class="chip" data-ctype="7">Dom 7</button>
            <button class="chip" data-ctype="maj7">Maj 7</button>
            <button class="chip" data-ctype="dim">dim</button>
            <button class="chip" data-ctype="aug">aug</button>
        </div>
        <div class="cp-label">Modale Skalen</div>
        <div class="chip-row" id="scaleRow">
            <button class="chip" data-scale="dorian">Dorisch</button>
            <button class="chip" data-scale="mixolydian">Mixolydisch</button>
            <button class="chip" data-scale="phrygian">Phrygisch</button>
            <button class="chip" data-scale="lydian">Lydisch</button>
        </div>
        <div class="cp-label">Grundton</div>
        <div class="root-grid" id="rootGrid"></div>
    </div>

    <div id="pieceSection">
        <div class="sec-hdr" style="margin-top:6px;">StÃ¼ck</div>
        <div class="piece-row">
            <select id="pieceSelect">
                <option value="">â€” StÃ¼ck wÃ¤hlen â€”</option>
                <option value="bourree-avignon">BourrÃ©e d'Avignon (D-moll)</option>
                <option value="bourree-malochet">BourrÃ©e Ã  Malochet (G-Dur)</option>
                <option value="chapelloise">Chapelloise (G-Dur)</option>
                <option value="scottish-berry">Scottish du Berry (G-Dur)</option>
                <option value="polka-tailleurs">Polka des Tailleurs (C-Dur)</option>
            </select>
        </div>
    </div>
</div>

<!-- â”€â”€ AKKORDEON â€“ PULL â”€â”€ -->
<div class="layout-section visible" id="pull-layout">
    <div class="accordion-flex">
        <div class="bass-side">
            <div class="lay-title">Bass â€“ Pull</div>
            <div class="bass-container" id="bass-pull"></div>
        </div>
        <div class="treble-wrapper">
            <div class="lay-title">Diskant â€“ Pull (Ziehen) â€“ Sicht von oben</div>
            <div class="treble-side" id="treble-pull"></div>
        </div>
    </div>
</div>

<!-- â”€â”€ AKKORDEON â€“ PUSH â”€â”€ -->
<div class="layout-section" id="push-layout">
    <div class="accordion-flex">
        <div class="bass-side">
            <div class="lay-title">Bass â€“ Push</div>
            <div class="bass-container" id="bass-push"></div>
        </div>
        <div class="treble-wrapper">
            <div class="lay-title">Diskant â€“ Push (DrÃ¼cken) â€“ Sicht von oben</div>
            <div class="treble-side" id="treble-push"></div>
        </div>
    </div>
</div>

<!-- â”€â”€ INFO â”€â”€ -->
<div class="info-panel" id="infoPanel">
    <div class="ip-title">StÃ¼ck-Info</div>
    <div class="info-grid">
        <div class="info-item"><div class="il">Tonart</div><div class="iv" id="infoKey">â€”</div></div>
        <div class="info-item"><div class="il">Hauptreihe</div><div class="iv" id="infoRow">â€”</div></div>
        <div class="info-item"><div class="il">Helferreihe</div><div class="iv" id="infoHelper">â€”</div></div>
        <div class="info-item"><div class="il">Balg</div><div class="iv" id="infoBellows">â€”</div></div>
    </div>
</div>

<!-- â”€â”€ LEGENDE â”€â”€ -->
<div class="legend" id="legend">
    <div class="lg-title">Legende</div>
    <div class="lg-row"><div class="lg-sw pearl"></div>Taste â€“ nicht aktiv (Perlmutt)</div>
    <div class="lg-row"><div class="lg-sw act"></div>Taste â€“ aktiv (helles Grau)</div>
    <div class="lg-row"><div class="lg-sw root"></div>Grundton des Akkords (dunkles Grau)</div>
    <div class="lg-row"><div class="lg-sw scale"></div>Skalenton (bei modalen Skalen)</div>
</div>

</div><!-- /container -->

<script>
// [... JavaScript bleibt komplett gleich wie vorher ...]
const layout = {
    pull: {
        treble: {
            Heim: ['C# 10','Bb 9','G# 8','G 7','C# 6','Bb 5','G# 4','G 3','C# 2','Bb 1'],
            C:    ['D 11','B 10','A 9','F 8','D 7','B 6','A 5','F 4','D 3','B 2','G 1'],
            G:    ['C 12','A 11','F# 10','E 9','C 8','A 7','F# 6','E 5','C 4','A 3','F# 2','E 1']
        },
        bass: { col1:['G','g','D','d','B','b'], col2:['F','f','A','a','Bb','bb'] }
    },
    push: {
        treble: {
            Heim: ['G# 10','Eb 9','A 8','G# 7','Eb 6','A 5','G# 4','Eb 3','A 2','G# 1'],
            C:    ['G 11','E 10','C 9','G 8','E 7','C 6','G 5','E 4','C 3','G 2','E 1'],
            G:    ['G 12','D 11','B 10','G 9','D 8','B 7','G 6','D 5','B 4','G 3','D 2','B 1']
        },
        bass: { col1:['C','c','G','g','Ab','ab'], col2:['F','f','E','e','Eb','eb'] }
    }
};

const pieces = {
    'bourree-avignon': {
        name:"BourrÃ©e d'Avignon", key:"D-moll", row:"G + Helferreihe",
        helper:"E, F (zwingend)", bellows:"â‰ˆ 90 % Pull",
        notes:{ pull:{ treble:['E 9','D 7','A 7','F# 10','C 8'], bass:['D','d','A','a'] },
                push:{ treble:['D 11','G 9'], bass:[] } }
    },
    'bourree-malochet': {
        name:"BourrÃ©e Ã  Malochet", key:"G-Dur (dorisch)", row:"G-Reihe + Helfer",
        helper:"F fÃ¼r dorischen Charakter", bellows:"kurze Akzente",
        notes:{ pull:{ treble:['A 7','F# 10','E 9','C 8','A 3'], bass:['G','g','D','d'] },
                push:{ treble:['G 9','D 8','B 10'], bass:['G','g'] } }
    },
    'chapelloise': {
        name:"Chapelloise", key:"G-Dur", row:"G-Reihe",
        helper:"nicht nÃ¶tig", bellows:"extrem stabil, lange Push-Phasen",
        notes:{ pull:{ treble:['A 7','F# 6','E 5','C 4','A 3'], bass:['G','g'] },
                push:{ treble:['G 12','G 9','D 11','B 10','G 6'], bass:['G','g','C','c'] } }
    },
    'scottish-berry': {
        name:"Scottish du Berry", key:"G-Dur", row:"G + C",
        helper:"c / d zum GlÃ¤tten", bellows:"bewusst rhythmisch",
        notes:{ pull:{ treble:['A 7','F# 10','E 9','C 8','B 10'], bass:['G','g','D','d'] },
                push:{ treble:['G 9','D 8','B 10','E 10'], bass:['G','g','C','c'] } }
    },
    'polka-tailleurs': {
        name:"Polka des Tailleurs", key:"C-Dur", row:"C-Reihe",
        helper:"optional f", bellows:"regelmÃ¤ÃŸig, vorhersehbar",
        notes:{ pull:{ treble:['B 6','A 5','F 4','D 3','B 2'], bass:['G','g'] },
                push:{ treble:['C 9','E 10','G 8','C 6'], bass:['G','g','C','c'] } }
    }
};

const CHORD = { maj:[0,4,7], min:[0,3,7], '7':[0,4,7,10], maj7:[0,4,7,11], dim:[0,3,6], aug:[0,4,8] };
const SCALE = { dorian:[0,2,3,5,7,9,10], mixolydian:[0,2,4,5,7,9,10], phrygian:[0,1,3,5,7,8,10], lydian:[0,2,4,6,7,9,11] };
const N2S = { C:0,'C#':1,Db:1,D:2,'D#':3,Eb:3,E:4,F:5,'F#':6,Gb:6,G:7,'G#':8,Ab:8,A:9,'A#':10,Bb:10,B:11 };
const S2N = ['C','C#','D','Eb','E','F','F#','G','G#','A','Bb','B'];
const ROOTS = ['C','D','E','F','G','A','Bb','Ab','Eb'];

let dir='pull', mode='normal', activeNotes=new Set(), chordRoot=null, chordType='maj', scaleType=null;

function pureName(s){ return s.replace(/\s*\d+$/,'').trim(); }
function bassToRoot(s){ const m=s.match(/^([A-G][b#]?)/); return m?m[1]:s.charAt(0).toUpperCase(); }

function renderAll(){ ['pull','push'].forEach(d=>{ renderTreble(d); renderBass(d); }); }

function renderTreble(d){
    const cont = document.getElementById('treble-'+d);
    cont.innerHTML = '';
    ['Heim','C','G'].forEach(row => {
        const div = document.createElement('div');
        div.className = 'row';
        const lbl = document.createElement('div');
        lbl.className = 'row-label';
        lbl.textContent = row==='Heim'?'HELFER (10)':row==='C'?'C-REIHE (11)':'G-REIHE (12)';
        div.appendChild(lbl);
        layout[d].treble[row].forEach(note => {
            const btn = document.createElement('div');
            btn.className = 'note-button';
            btn.dataset.note = note;
            const sp = document.createElement('div');
            sp.className = 'note-name';
            sp.textContent = note;
            btn.appendChild(sp);
            btn.addEventListener('click', ()=> onTrebleClick(note, d));
            div.appendChild(btn);
        });
        cont.appendChild(div);
    });
    applyStyles(d);
}

function renderBass(d){
    const cont = document.getElementById('bass-'+d);
    cont.innerHTML = '';
    ['col1','col2'].forEach(col => {
        const column = document.createElement('div');
        column.className = 'bass-column';
        const lbl = document.createElement('div');
        lbl.className = 'bass-col-label';
        lbl.textContent = 'Spalte '+(col==='col1'?'1':'2');
        column.appendChild(lbl);
        layout[d].bass[col].forEach(note => {
            const btn = document.createElement('div');
            btn.className = 'bass-button';
            if(note !== note.toUpperCase()) btn.classList.add('is-chord');
            btn.dataset.note = note;
            btn.textContent  = note;
            btn.addEventListener('click', ()=> onBassClick(note, d));
            column.appendChild(btn);
        });
        cont.appendChild(column);
    });
    applyStyles(d);
}

function renderRootGrid(){
    const grid = document.getElementById('rootGrid');
    grid.innerHTML = '';
    ROOTS.forEach(r => {
        const btn = document.createElement('button');
        btn.className = 'root-btn';
        btn.dataset.root = r;
        btn.textContent  = r;
        btn.addEventListener('click', ()=> selectRoot(r));
        grid.appendChild(btn);
    });
}

function applyStyles(d){
    let rootSet=new Set(), chordSet=new Set();
    if(mode==='chord' && chordRoot){
        rootSet.add(chordRoot);
        const formula = scaleType ? SCALE[scaleType] : CHORD[chordType];
        const base = N2S[chordRoot];
        formula.forEach(i => chordSet.add(S2N[(base+i)%12]));
    }

    document.querySelectorAll('#treble-'+d+' .note-button').forEach(btn => {
        const note = btn.dataset.note, key=d+'-treble-'+note, name=pureName(note);
        btn.classList.remove('active','root','scale-tone');
        if(mode==='chord'){
            if(rootSet.has(name)){ btn.classList.add('root','active'); }
            else if(chordSet.has(name)){ btn.classList.add('active'); }
        } else {
            if(activeNotes.has(key)) btn.classList.add('active');
        }
        if(mode==='chord' && scaleType && chordSet.has(name) && !rootSet.has(name)){
            btn.classList.add('scale-tone');
        }
    });

    document.querySelectorAll('#bass-'+d+' .bass-button').forEach(btn => {
        const note = btn.dataset.note;
        btn.classList.remove('active');
        if(mode==='normal' && activeNotes.has(d+'-bass-'+note)){ btn.classList.add('active'); }
    });
}

function onTrebleClick(note, d){
    if(mode==='chord') return;
    const key = d+'-treble-'+note;
    activeNotes.has(key) ? activeNotes.delete(key) : activeNotes.add(key);
    applyStyles(d);
}

function onBassClick(note, d){
    if(mode==='chord') return;
    const isUpper = (note === note.toUpperCase()), root=bassToRoot(note);
    activeNotes.clear(); applyStyles('pull'); applyStyles('push');
    activeNotes.add(d+'-bass-'+note);
    const formula = isUpper ? CHORD.maj : CHORD.min;
    const base=N2S[root], tones=formula.map(i=>S2N[(base+i)%12]);
    ['Heim','C','G'].forEach(row => {
        layout[d].treble[row].forEach(n => {
            if(tones.includes(pureName(n))){ activeNotes.add(d+'-treble-'+n); }
        });
    });
    applyStyles(d);
}

function selectRoot(root){
    chordRoot = root;
    document.querySelectorAll('.root-btn').forEach(b => b.classList.toggle('active', b.dataset.root===root));
    applyStyles('pull'); applyStyles('push');
}

function loadPiece(id){
    activeNotes.clear();
    if(!id || !pieces[id]){ document.getElementById('infoPanel').classList.remove('visible'); applyStyles('pull'); applyStyles('push'); return; }
    const p=pieces[id], pn=p.notes[dir];
    if(pn){ pn.treble.forEach(n=>activeNotes.add(dir+'-treble-'+n)); pn.bass.forEach(n=>activeNotes.add(dir+'-bass-'+n)); }
    document.getElementById('infoKey').textContent=p.key;
    document.getElementById('infoRow').textContent=p.row;
    document.getElementById('infoHelper').textContent=p.helper;
    document.getElementById('infoBellows').textContent=p.bellows;
    document.getElementById('infoPanel').classList.add('visible');
    applyStyles(dir);
}

function switchMode(newMode){
    mode=newMode; activeNotes.clear(); chordRoot=null;
    document.getElementById('pieceSelect').value='';
    document.getElementById('infoPanel').classList.remove('visible');
    document.getElementById('chordPanel').classList.toggle('visible',newMode==='chord');
    document.getElementById('pieceSection').style.display=newMode==='normal'?'':'none';
    document.getElementById('legend').classList.toggle('visible',newMode==='chord');
    document.querySelectorAll('.root-btn').forEach(b=>b.classList.remove('active'));
    applyStyles('pull'); applyStyles('push');
}

function switchDir(newDir){
    dir=newDir;
    document.getElementById('pull-layout').classList.toggle('visible',newDir==='pull');
    document.getElementById('push-layout').classList.toggle('visible',newDir==='push');
    const sel=document.getElementById('pieceSelect').value;
    if(sel && mode==='normal') loadPiece(sel);
}

document.querySelectorAll('.seg button').forEach(btn => {
    btn.addEventListener('click', ()=>{
        document.querySelectorAll('.seg button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active'); switchDir(btn.dataset.dir);
    });
});

document.querySelectorAll('.mode-pill').forEach(btn => {
    btn.addEventListener('click', ()=>{
        document.querySelectorAll('.mode-pill').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active'); switchMode(btn.dataset.mode);
    });
});

document.querySelectorAll('.chip[data-ctype]').forEach(btn => {
    btn.addEventListener('click', ()=>{
        document.querySelectorAll('.chip[data-ctype]').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active'); chordType=btn.dataset.ctype; scaleType=null;
        document.querySelectorAll('.chip[data-scale]').forEach(b=>b.classList.remove('active'));
        applyStyles('pull'); applyStyles('push');
    });
});

document.querySelectorAll('.chip[data-scale]').forEach(btn => {
    btn.addEventListener('click', ()=>{
        const was=btn.classList.contains('active');
        document.querySelectorAll('.chip[data-scale]').forEach(b=>b.classList.remove('active'));
        scaleType=was?null:btn.dataset.scale;
        if(!was) btn.classList.add('active');
        if(scaleType) document.querySelectorAll('.chip[data-ctype]').forEach(b=>b.classList.remove('active'));
        applyStyles('pull'); applyStyles('push');
    });
});

document.getElementById('pieceSelect').addEventListener('change', e=>loadPiece(e.target.value));

renderRootGrid(); renderAll();
</script>
</body>
</html>